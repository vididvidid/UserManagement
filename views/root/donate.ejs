<%- include('../partials/header', { title: 'Donate Us | SDPMSS' }) %>
<div class="container mt-5">
    <h2>Donate to Our Cause</h2>
    <p>Your generous donations help us continue our work and make a difference in the community. Choose an amount to donate or enter a custom amount.</p>

    <form id="donationForm">
        <div class="btn-group btn-group-toggle mb-3" data-toggle="buttons">
            <label class="btn btn-outline-primary">
                <input type="radio" name="amount" value="10"> ₹10
            </label>
            <label class="btn btn-outline-primary">
                <input type="radio" name="amount" value="50"> ₹50
            </label>
            <label class="btn btn-outline-primary">
                <input type="radio" name="amount" value="100"> ₹100
            </label>
            <label class="btn btn-outline-primary">
                <input type="radio" name="amount" value="500"> ₹500
            </label>
            <label class="btn btn-outline-primary">
                <input type="radio" name="amount" value="1000"> ₹1000
            </label>
            <label class="btn btn-outline-primary" id="customLabel">
                <input type="radio" name="amount" value="custom" id="customRadio"> Custom
            </label>
            <input type="number" class="form-control custom-amount" id="customAmount" name="customAmount" placeholder="Enter amount">
        </div>
        

        <% if (!user) { %>
            <div class="form-group form-check">
                <input type="checkbox" class="form-check-input" id="anonymousDonation" name="anonymousDonation">
                <label class="form-check-label" for="anonymousDonation">Donate anonymously</label>
            </div>
            <% } %>
        <!-- Donor Information -->
        <div id="donorInfo">
            <div class="form-group">
                <label for="donorName">Name</label>
                <input type="text" class="form-control" id="donorName" name="donorName" value="<%= user ? `${user.firstname} ${user.middlename} ${user.lastname}` : '' %>">
            </div>
            <div class="form-group">
                <label for="donorEmail">Email address</label>
                <input type="email" class="form-control" id="donorEmail" name="donorEmail" placeholder="Your Email">
            </div>
            <div class="form-group">
                <label for="donorMessage">Message</label>
                <textarea class="form-control" id="donorMessage" name="donorMessage" rows="3" placeholder="Your Message"></textarea>
            </div>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary">Donate Now</button>
    </form>

    <!-- See Full Records Button -->
    <% if (user) { %>
        <div id="fullRecordsContainer">
            <button class="btn btn-secondary mt-3" id="seeFullRecords">See Full Records</button>
            <div id="donationRecords" class="mt-3"></div>
        </div>
    <% } %>
</div>

</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- <script src="https://checkout.razorpay.com/v1/checkout.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script> -->
<script>
$(document).ready(function() {
    const user = "<%= JSON.stringify(user || null) %>";
    const isAuthenticated = !!user;

    if (isAuthenticated) {
        $('#fullRecordsContainer').show();
    }

    $('#anonymousDonation').change(function() {
        if ($(this).is(':checked')) {
            $('#donorInfo').hide();
            $('#fullRecordsContainer').hide();
        } else {
            $('#donorInfo').show();
            if (isAuthenticated) {
                $('#fullRecordsContainer').show();
            }
        }
    });

    $('#donationForm').submit(function(event) {
        event.preventDefault();

        const amount = $('input[name="amount"]:checked').val() || $('#customAmount').val();
        if (!amount) {
            alert("Please select or enter a donation amount.");
            return;
        }

        const formData = {
            amount: amount,
            anonymous: isAuthenticated ? false : $('#anonymousDonation').is(':checked'),
            donorName: $('#donorName').val(),
            donorEmail: $('#donorEmail').val(),
            donorMessage: $('#donorMessage').val()
        };

        $.ajax({
            type: "POST",
            url: "/donate/donate",
            data: JSON.stringify(formData),
            contentType: "application/json",
            success: function(response) {
                alert("Thank you for your donation!");
                // Open the payment URL in a new popup window
                const paymentWindow = window.open(response, 'PaymentWindow', 'width=800,height=600');
                // Optionally, clear the form or redirect the user
                $('#donationForm')[0].reset();
                if (isAuthenticated) {
                    $('#donorName').val(`${user.firstname} ${user.middlename} ${user.lastname}`);
                }
            },
            error: function(error) {
                alert("There was an error processing your donation. Please try again.");
            }
        });

    });
});



    //     $.ajax({
    //         url: '/donate/donate',
    //         type: 'POST',
    //         contentType: 'application/json',
    //         data: JSON.stringify(formData),
    //         success: function(response) {
    //             console.log("Donation initiated");
    //             if (response.orderId) {
    //                 var options = {
    //                     "key": "<%= process.env.RAZORPAY_KEY_ID %>",
    //                     "amount": amount * 100,
    //                     "currency": "INR",
    //                     "name": "Your Organization Name",
    //                     "description": "Donation",
    //                     "order_id": response.orderId,
    //                     "handler": function (paymentResponse) {
    //                         $.ajax({
    //                             url: '/donate/afterdonatestatus',
    //                             type: 'POST',
    //                             contentType: 'application/json',
    //                             data: JSON.stringify({
    //                                 orderId: response.orderId,
    //                                 paymentId: paymentResponse.razorpay_payment_id
    //                             }),
    //                             success: function(statusResponse) {
    //                                 alert('Donation successful! Thank you for your contribution.');
    //                                 generatePDF(user, response.orderId, paymentResponse.razorpay_payment_id, amount);
    //                             },
    //                             error: function(error) {
    //                                 console.error('Error updating donation status:', error);
    //                                 alert('There was an error updating the donation status. Please contact support.');
    //                             }
    //                         });
    //                     },
    //                     "prefill": {
    //                         "name": formData.donorName,
    //                         "email": formData.donorEmail
    //                     },
    //                     "theme": {
    //                         "color": "#3399cc"
    //                     }
    //                 };
    //                 var rzp1 = new Razorpay(options);
    //                 rzp1.open();
    //             } else {
    //                 alert('Donation successful! Thank you for your contribution.');
    //             }
    //         },
    //         error: function(error) {
    //             console.error('Error:', error);
    //             alert('There was an error processing your donation. Please try again.');
    //         }
    //     });
    // });

//     function generatePDF(user, orderId, paymentId, amount) {
//         const { jsPDF } = window.jspdf;
//         const doc = new jsPDF();

//         doc.addImage('assests/sdpmssLogo.jpg', 30, 10, 50, 20);
//         doc.setFontSize(16);
//         doc.text("Donation Receipt", 60, 40, null, null, 'center');

//         doc.setFontSize(12);
//         if (user) {
//             doc.text(`Name: ${user.firstname} ${user.middlename} ${user.lastname}`, 10, 50);
//             doc.text(`Email: ${user.email}`, 10, 60);
//         } else {
//             doc.text(`Name: Anonymous`, 10, 50);
//         }
//         doc.text(`Order ID: ${orderId}`, 10, 70);
//         doc.text(`Payment ID: ${paymentId}`, 10, 80);
//         doc.text(`Amount: Rupees${amount}`, 10, 90);
//         doc.text(`Date: ${new Date().toLocaleDateString()}`, 10, 100);

//         doc.save("Donation_Receipt.pdf");
//     }

//     $('#seeFullRecords').click(function() {
//             $.ajax({
//                 url: '/donate/record',
//                 type: 'GET',
//                 success: function(response) {
//                     // Display the donation records as needed
//                     console.log(response);
//                     displayDonationRecords(response);
//                 },
//                 error: function(error) {
//                     console.error('Error fetching records:', error);
//                     alert('There was an error fetching your donation records. Please try again.');
//                 }
//             });
//         });
//         function displayDonationRecords(donations) {
//         let table = '<table class="table table-striped">';
//         table += '<thead><tr><th>Amount</th><th>Date</th><th>Order ID</th><th>Status</th><th>Name</th><th>Email</th><th>Message</th></tr></thead><tbody>';

//         donations.forEach(donation => {
//             table += `<tr>
//                         <td>₹${donation.amount}</td>
//                         <td>${new Date(donation.createdAt).toLocaleDateString()}</td>
//                         <td>${donation.orderId}</td>
//                         <td>${donation.status}</td>
//                         <td>${donation.donorName}</td>
//                         <td>${donation.donorEmail}</td>
//                         <td>${donation.donorMessage}</td>
//                       </tr>`;
//         });

//         table += '</tbody></table>';
//         $('#donationRecords').html(table);
//     }
// });

</script>





<%- include('../partials/footer') %>